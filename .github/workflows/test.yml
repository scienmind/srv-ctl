name: CI Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  syntax-and-lint:
    name: Syntax and Lint Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      
      - name: Check bash syntax
        run: |
          echo "Checking srv-ctl.sh..."
          bash -n srv-ctl.sh
          echo "Checking lib/os-utils.sh..."
          bash -n lib/os-utils.sh
          echo "Checking lib/storage.sh..."
          bash -n lib/storage.sh
      
      - name: Prepare test config
        run: |
          # Use test config for validation
          cp tests/fixtures/config.local.test config.local
      
      - name: Run ShellCheck
        run: |
          echo "ShellCheck srv-ctl.sh..."
          shellcheck -x srv-ctl.sh
          echo "ShellCheck lib/os-utils.sh..."
          shellcheck -x lib/os-utils.sh
          echo "ShellCheck lib/storage.sh..."
          shellcheck -x lib/storage.sh

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: syntax-and-lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install bats
        run: npm install -g bats
      
      - name: Run unit tests
        run: |
          echo "Running unit tests..."
          bats tests/unit/test-os-utils.bats
          bats tests/unit/test-storage.bats

  integration-tests:
    name: Integration Tests (${{ matrix.os }})
    runs-on: ubuntu-latest
    needs: unit-tests
    
    strategy:
      fail-fast: false
      matrix:
        os:
          - debian:10
          - debian:11
          - debian:12
          - debian:13
          - ubuntu:18.04
          - ubuntu:20.04
          - ubuntu:22.04
          - ubuntu:24.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run integration tests in Docker
        run: |
          docker run --rm \
            --privileged \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ${{ matrix.os }} \
            bash -c '
              set -euo pipefail
              
              # Update package lists
              if command -v apt-get &>/dev/null; then
                apt-get update -qq
              fi
              
              # Install dependencies
              echo "Installing dependencies..."
              if command -v apt-get &>/dev/null; then
                apt-get install -y -qq \
                  bash \
                  cryptsetup \
                  lvm2 \
                  dosfstools \
                  ntfs-3g \
                  util-linux \
                  sudo
              fi
              
              # Setup test environment
              echo "Setting up test environment..."
              bash tests/fixtures/setup-test-env.sh
              
              # Run integration tests
              echo "Running LUKS tests..."
              bash tests/integration/test-luks.sh
              
              echo "Running LVM tests..."
              bash tests/integration/test-lvm.sh
              
              echo "Running mount tests..."
              bash tests/integration/test-mount.sh
              
              # Cleanup
              echo "Cleaning up..."
              bash tests/fixtures/cleanup-test-env.sh
              
              echo "All integration tests passed on ${{ matrix.os }}!"
            '
      
      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ matrix.os }}
          path: |
            /tmp/test_env.conf
            /var/log/syslog
          if-no-files-found: ignore

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [syntax-and-lint, unit-tests, integration-tests]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "Test Results:"
          echo "  Syntax and Lint: ${{ needs.syntax-and-lint.result }}"
          echo "  Unit Tests: ${{ needs.unit-tests.result }}"
          echo "  Integration Tests: ${{ needs.integration-tests.result }}"
          
          if [[ "${{ needs.syntax-and-lint.result }}" != "success" ]] || \
             [[ "${{ needs.unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.integration-tests.result }}" != "success" ]]; then
            echo "Some tests failed!"
            exit 1
          else
            echo "All tests passed!"
          fi
